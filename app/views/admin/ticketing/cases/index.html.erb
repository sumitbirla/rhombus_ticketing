<div class="pull-right">
  
  <select id="selAction" class="form-control" style="display: inline; width: 75%">
    <option> - - Select Action - - </option>
	  <option method="get" value="/admin/ticketing/case/new?queue_id=<%= params[:queue_id]%>">New Ticket</option>
    <option method="post" value="/admin/ticketing/cases_delete_batch">Delete Selected</option>
    <optgroup label="Change case status to ">
        <option method="post" value="/admin/ticketing/cases_update_status?status=new">New</option>
        <option method="post" value="/admin/ticketing/cases_update_status?status=open">Open</option>
        <option method="post" value="/admin/ticketing/cases_update_status?status=closed">Closed</option>
    </optgroup>
  </select>
  <input type="button" class="btn btn-default btn-small" id="btnAction" value="Go" />

</div>

<h2>
  <i class="fa fa-headphones"></i> 
  <%= params[:status].titlecase unless params[:status].blank? %> Cases
  <%= " assigned to " + User.find(params[:user_id]).name unless params[:user_id].nil? %>
  <select id="selQueue">
      <% CaseQueue.all.each do |q| %>
  	  <option <%= "selected" if q.id.to_s == params[:queue_id] %> value="<%= admin_ticketing_cases_path(status: params[:status], queue_id: q.id, user_id: params[:user_id])%>"><%= q.name %></option>
      <% end %>
  </select>
</h2>

<hr>
 

  <% 
    open_count = Case.where(status: :open, case_queue_id: params[:queue_id]).count 
    closed_count = Case.where(status: :closed, case_queue_id: params[:queue_id]).count 
    my_count = Case.where(status: :open, case_queue_id: params[:queue_id], assigned_to: session[:user_id]).count 
  %>

  <% if params[:q].nil? %>
  <ul class="nav nav-tabs" style="margin-bottom: 10px;">
    <li role="presentation" class="<%= "active" if params[:status] == "open" %>"><a href="<%= admin_ticketing_cases_path(status: "open", queue_id: params[:queue_id])%>">Open (<%= open_count %>)</a></li>
    <li role="presentation" class="<%= "active" if params[:status] == "closed" %>"><a href="<%= admin_ticketing_cases_path(status: "closed", queue_id: params[:queue_id]) %>">Closed (<%= closed_count %>)</a></li>
    <li role="presentation" class="<%= "active" if params[:user_id] == session[:user_id] %>"><a href="<%= admin_ticketing_cases_path(user_id: session[:user_id], queue_id: params[:queue_id]) %>">My Cases (<%= my_count %>)</a></li>
  </ul>
  <% end %>

<%= will_paginate @cases %>
<form id="frmBatch" action="" method="post">
	<%= token_tag %>
  <table class="table table-striped table-condensed">
  	<tr>
      <th><input type="checkbox" id="chkAll" /></th>
      <th>ID</th>
      <th>Received</th>
      <th>From</th>
      <th>Subject</th>
      <th>Status</th>
      <th>Priority</th>
      <th>Assigned to</th>
  	</tr>
  	<% @cases.each do |c| %>
  	<tr class="<%= "light" if c.status == "closed" %>">
      <td><input type="checkbox" name="case_id[]" class="shipment-chk" value="<%= c.id %>"/></td>
  		<td><%= link_to c.id, admin_ticketing_case_path(c) %></td>
      <td nowrap><%= systime c.received_at %></td>
      <td>
        <% if c.user %>
          <%= link_to c.user.name, admin_system_user_path(c.user_id) %>
        <% else %>
          <%= c.name %>
        <% end %>
      </td>
  		<td>
        <%= truncate c.subject, length: 40 %>
        <% unless c.attachments.blank? %>
          <i class="fa fa-paperclip"></i>
        <% end %>
      </td>
      <td><%= case_status_indicator c %></td>
      <td><%= case_priority_indicator c %></td>
  		<td><% unless c.assigned_to.nil? %>
  			<%= link_to c.assignee.name, admin_system_user_path(c.assigned_to) %>
  			<% else %>
  			- none -
  			<% end%>
  		</td>
  	</tr>
  	<% end %>
  </table>
</form>

<% content_for :title do %>
	Cases: <%= %>
<% end %>


<% content_for :menu do
    render "admin/shared/ticketing_menu"
end %>

<% content_for :breadcrumbs do %>
	<li><a href="#">Ticketing</a></li>
	<li><%= link_to "Queues", admin_ticketing_case_queues_path %></li>
  <li class="active">Cases</li>
<% end %>

<% content_for :head do %>

	<script type="text/javascript">
	    $(document).ready(function () {

	        $("#btnAction").click(function () {
	            $("#frmBatch").attr("action", $("#selAction").val());
	            $("#frmBatch").attr("method", $("#selAction option:selected").attr("method"));
	            $("#frmBatch").submit();
	        });
          
	        $("#selQueue").change(function () {
	            window.location = $("#selQueue option:selected").val();
	        });

          $("#chkAll").change(function() {

            if ($(this).prop("checked"))
              $(".shipment-chk").prop("checked", true);
            else
              $(".shipment-chk").prop("checked", false);
          });

	    });
    </script>

<% end %>
